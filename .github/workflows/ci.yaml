name: CI
permissions:
  contents: read
  security-events: write

concurrency:
  group: ci-${{ (github.ref == 'refs/heads/master' && github.sha) || (github.event_name == 'pull_request' && github.head_ref) || github.ref }}
  cancel-in-progress: false

on:
  pull_request:
    branches:
      - "master"
  push:
    branches:
      - "master"
  workflow_dispatch:
  merge_group:
    types: [checks_requested]

env:
  RUSTFLAGS: -Dwarnings
  MACOSX_DEPLOYMENT_TARGET: "14.5"

jobs:
  dependency_review:
    name: 'Dependency Review'
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: 'Checkout Repository'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
  build_and_test:
    needs:
      - cargo_fmt
      - style_and_docs
      - miri
      - check_minimal_versions
      - cargo_semver
      - dependency_review
    strategy:
      matrix:
        os: [ubuntu-latest, macOS-latest, windows-latest]
        rustalias: [stable, nightly, msrv]
        workspace: ["Cargo.toml", "fuzz/Cargo.toml"]
        feature_flag:
          - "--all-features"
          - "--no-default-features"
          - "--no-default-features --features zip/deflate-flate2-zlib-rs"
          - "--no-default-features --features zip/deflate-zopfli"
          - ""
        include:
          - rustalias: stable
            rust: stable
          - rustalias: msrv
            rust: "1.83"
          - rustalias: nightly
            rust: nightly
        exclude:
          - rustalias: msrv
            workspace: "fuzz/Cargo.toml"
    name: "Build and test ${{ matrix.feature_flag }} ${{ matrix.workspace }}: ${{ matrix.os }}, ${{ matrix.rustalias }}"
    runs-on: ${{ matrix.os }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - run: rustup toolchain add ${{ matrix.rust }} && rustup default ${{ matrix.rust }}

      - run: cargo check --manifest-path ${{ github.workspace }}/${{ matrix.workspace }} --all ${{ matrix.feature_flag }} --bins --examples
      - run: cargo test --manifest-path ${{ github.workspace }}/${{ matrix.workspace }} --all ${{ matrix.feature_flag }}
  wasm:
    needs: build_and_test
    strategy:
      matrix:
        browser_flags: ["--headless --chrome", "--headless --firefox", "--node"]
        rustalias: [stable, nightly]
        manifest: ["Cargo.toml"]
        feature_flag:
          - "" # default features
          - "--no-default-features"
          - "--features chrono,jiff-02,nt-time,legacy-zip"
        include:
          - rustalias: stable
            rust: stable
          - rustalias: nightly
            rust: nightly
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: target
          key: ${{ runner.os }}-rust-${{ hashFiles('Cargo.toml') }}
      - run: rustup toolchain add ${{ matrix.rust }} && rustup default ${{ matrix.rust }}
      - run: rustup target add wasm32-unknown-unknown
      - run: cargo install wasm-pack --locked
      - run: wasm-pack test ${{ matrix.browser_flags }} --manifest-path ${{ github.workspace }}/${{ matrix.manifest }} ${{ matrix.feature_flag }}
  miri:
    strategy:
      matrix:
        workspace: ["Cargo.toml", "fuzz/Cargo.toml"]
        feature_flag:
          - "--all-features"
          - "--no-default-features"
          - ""
          - "--no-default-features --features zip/deflate-flate2-zlib-rs"
          - "--no-default-features --features zip/deflate-zopfli"
    name: "Miri ${{ matrix.feature_flag }} ${{ matrix.workspace }}"
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: target
          key: ${{ runner.os }}-rust-${{ hashFiles('Cargo.toml') }}
      - run: sudo apt update
      - run: sudo apt install crossbuild-essential-s390x
      - run: rustup toolchain add nightly-x86_64-unknown-linux-gnu
      - run: rustup toolchain add --force-non-host stable-s390x-unknown-linux-gnu
      - run: rustup target add s390x-unknown-linux-gnu --toolchain stable-s390x-unknown-linux-gnu
      - run: rustup component add --toolchain nightly-x86_64-unknown-linux-gnu miri
      - run: cargo +nightly miri test --manifest-path ${{ github.workspace }}/${{ matrix.workspace }} --target s390x-unknown-linux-gnu --all ${{ matrix.feature_flag }} --bins --examples
  cargo_semver:
    strategy:
      matrix:
        # Only do semver checks on the released library.
        workspace: ["Cargo.toml"]
        feature_group:
          ["all-features", "default-features", "only-explicit-features"]
    name: "Semver checks: ${{ matrix.feature_group }}"
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: obi1kenobi/cargo-semver-checks-action@5b298c9520f7096a4683c0bd981a7ac5a7e249ae # v2.8
        with:
          manifest-path: ${{ github.workspace }}/${{ matrix.workspace }}
          feature-group: ${{ matrix.feature_group }}
          baseline-version: 7.3.0-pre1
  cargo_fmt:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: target
          key: ${{ runner.os }}-rust-${{ hashFiles('Cargo.toml') }}
      - run: rustup toolchain add nightly && rustup default nightly && rustup component add rustfmt
      - name: fmt
        run: cargo fmt --all -- --check
      - name: fmt fuzz
        run: cargo fmt --all --manifest-path ${{ github.workspace }}/fuzz/Cargo.toml -- --check

  check_minimal_versions:
    strategy:
      matrix:
        # Only check minimal versions for the released library.
        workspace: ["Cargo.toml"]
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - run: rustup toolchain add nightly && rustup default nightly

      - name: resolve minimal versions
        run: cargo -Z minimal-versions update --manifest-path ${{ github.workspace }}/${{ matrix.workspace }}
      - name: check
        run: cargo check --all-features --manifest-path ${{ github.workspace }}/${{ matrix.workspace }}
      - name: test
        run: cargo test --all-features --manifest-path ${{ github.workspace }}/${{ matrix.workspace }}

  style_and_docs:
    strategy:
      matrix:
        workspace: ["Cargo.toml", "fuzz/Cargo.toml"]
        feature_flag: ["--all-features", "--no-default-features", ""]
    name: "Style and docs ${{ matrix.feature_flag }} ${{ matrix.workspace }}"
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - run: rustup toolchain add nightly && rustup default nightly && rustup component add clippy
      - name: Install required cargo
        run: cargo install clippy-sarif sarif-fmt
      - run: cargo clippy --workspace ${{ matrix.feature_flag }} --manifest-path ${{ github.workspace }}/${{ matrix.workspace }} -- -D warnings --message-format=json | clippy-sarif | tee rust-clippy-results.sarif | sarif-fmt
      - name: Upload analysis results to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10
        with:
          sarif_file: rust-clippy-results.sarif
          wait-for-processing: true
      - run: cargo doc --no-deps --workspace ${{ matrix.feature_flag }} --manifest-path ${{ github.workspace }}/${{ matrix.workspace }}

  fuzz_read:
    runs-on: ubuntu-latest
    needs:
      - build_and_test
      - wasm
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - run: rustup toolchain add nightly && rustup default nightly && rustup component add clippy

      - run: cargo install cargo-afl --version 0.15.19

      - name: cargo afl system-config
        run: cargo afl system-config
      - name: clippy
        run: cargo afl clippy --all-features -p fuzz_read --manifest-path ${{ github.workspace }}/fuzz/Cargo.toml -- -D warnings
      - name: compile fuzz
        run: cargo afl build --all-features -p fuzz_read --manifest-path ${{ github.workspace }}/fuzz/Cargo.toml
      - name: run fuzz
        timeout-minutes: 130
        run: cargo afl fuzz -i ${{ github.workspace }}/fuzz/read/in -o out -V 7200 -- ${{ github.workspace }}/fuzz/target/debug/fuzz_read
      - name: Minimize corpus
        run: cargo afl cmin -i out/default/queue -o out_cmin -- ${{ github.workspace }}/fuzz/target/debug/fuzz_read
      - name: Report coverage
        run: cargo afl showmap -C -i out -o map -- ${{ github.workspace }}/fuzz/target/debug/fuzz_read
      - run: sudo apt install rename
        if: always()
      - name: Rename files
        if: always()
        run: |
          find out -type f -name '*:*' -exec rename 's/:/-/g' {} \+
          find out_cmin -type f -name '*:*' -exec rename 's/:/-/g' {} \+
          find map -type f -name '*:*' -exec rename 's/:/-/g' {} \+
      - name: Upload updated corpus
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: fuzz_read_corpus
          path: out_cmin/*
      - name: Upload any failure inputs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: fuzz_read_bad_inputs
          path: out/default/crashes/*
          if-no-files-found: ignore
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: fuzz_read_coverage
          path: map

  fuzz_read_with_no_features:
    runs-on: ubuntu-latest
    needs:
      - build_and_test
      - wasm
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - run: rustup toolchain add nightly && rustup default nightly && rustup component add clippy

      - run: cargo install cargo-afl --version 0.15.19

      - name: cargo afl system-config
        run: cargo afl system-config
      - name: clippy
        run: cargo afl clippy --no-default-features -p fuzz_read --manifest-path ${{ github.workspace }}/fuzz/Cargo.toml -- -D warnings
      - name: compile fuzz
        run: cargo afl build -p fuzz_read --manifest-path ${{ github.workspace }}/fuzz/Cargo.toml
      - name: run fuzz
        timeout-minutes: 130
        run: cargo afl fuzz -i ${{ github.workspace }}/fuzz/read/in -o out -V 7200 -- ${{ github.workspace }}/fuzz/target/debug/fuzz_read
      - name: Report coverage
        run: cargo afl showmap -C -i out -o map -- ${{ github.workspace }}/fuzz/target/debug/fuzz_read
      - run: sudo apt install rename
        if: always()
      - name: Rename files
        if: always()
        run: |
          find out -type f -name '*:*' -exec rename 's/:/-/g' {} \+
          find map -type f -name '*:*' -exec rename 's/:/-/g' {} \+
      - name: Upload any failure inputs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: fuzz_read_bad_inputs_no_features
          path: out/default/crashes/*
          if-no-files-found: ignore
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: fuzz_read_coverage_no_features
          path: map

  fuzz_write:
    runs-on: ubuntu-latest
    needs:
      - build_and_test
      - wasm
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - run: rustup toolchain add nightly && rustup default nightly && rustup component add clippy

      - run: cargo install cargo-afl --version 0.15.19

      - name: cargo afl system-config
        run: cargo afl system-config
      - name: clippy
        run: cargo afl clippy --all-features -p fuzz_write --manifest-path ${{ github.workspace }}/fuzz/Cargo.toml -- -D warnings
      - name: compile fuzz
        run: cargo afl build --all-features -p fuzz_write --manifest-path ${{ github.workspace }}/fuzz/Cargo.toml
      - name: run fuzz
        timeout-minutes: 130
        run: cargo afl fuzz -i ${{ github.workspace }}/fuzz/write/in -o out -V 7200 -x ${{ github.workspace }}/fuzz/write/fuzz.dict -- ${{ github.workspace }}/fuzz/target/debug/fuzz_write
      - name: Minimize corpus
        run: cargo afl cmin -i out/default/queue -o out_cmin -- ${{ github.workspace }}/fuzz/target/debug/fuzz_write
      - name: Report coverage
        run: cargo afl showmap -C -i out -o map -- ${{ github.workspace }}/fuzz/target/debug/fuzz_write
      - run: sudo apt install rename
        if: always()
      - name: Rename files
        if: always()
        run: |
          find out -type f -name '*:*' -exec rename 's/:/-/g' {} \+
          find out_cmin -type f -name '*:*' -exec rename 's/:/-/g' {} \+
          find map -type f -name '*:*' -exec rename 's/:/-/g' {} \+
      - name: Upload updated corpus
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: fuzz_write_corpus
          path: out_cmin/*
      - name: Upload any failure inputs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: fuzz_write_bad_inputs
          path: out/default/crashes/*
          if-no-files-found: ignore
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: fuzz_write_coverage
          path: map

  fuzz_write_with_no_features:
    runs-on: ubuntu-latest
    needs:
      - build_and_test
      - wasm
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - run: rustup toolchain add nightly && rustup default nightly && rustup component add clippy

      - run: cargo install cargo-afl --version 0.15.19

      - name: cargo afl system-config
        run: cargo afl system-config
      - name: clippy
        run: cargo afl clippy --no-default-features -p fuzz_write --manifest-path ${{ github.workspace }}/fuzz/Cargo.toml -- -D warnings
      - name: compile fuzz
        run: cargo afl build --all-features -p fuzz_write --manifest-path ${{ github.workspace }}/fuzz/Cargo.toml
      - name: run fuzz
        timeout-minutes: 130
        run: cargo afl fuzz -i ${{ github.workspace }}/fuzz/write/in -o out -V 7200 -x ${{ github.workspace }}/fuzz/write/fuzz.dict -- ${{ github.workspace }}/fuzz/target/debug/fuzz_write
      - name: Report coverage
        run: cargo afl showmap -C -i out -o map -- ${{ github.workspace }}/fuzz/target/debug/fuzz_write
      - run: sudo apt install rename
        if: always()
      - name: Rename files
        if: always()
        run: |
          find out -type f -name '*:*' -exec rename 's/:/-/g' {} \+
          find map -type f -name '*:*' -exec rename 's/:/-/g' {} \+
      - name: Upload any failure inputs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: fuzz_write_bad_inputs_no_features
          path: out/default/crashes/*
          if-no-files-found: ignore
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: fuzz_write_coverage_no_features
          path: map
